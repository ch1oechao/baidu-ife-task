define(["util","data"],function(a,b){var c={todoTotal:a.$("#todo-total-count"),todoCateList:a.$(".todo-category-list")[0],todoInventory:a.$(".todo-inventory-category")[0].children,taskInventory:a.$(".todo-inventory-detail")[0],todoEditIcon:a.$(".fa-pencil-square-o")[0],todoCheckIcon:a.$(".fa-check-square-o")[0],todoUndoEle:a.$(".fa-undo")[0],todoCheckEle:a.$(".fa-check")[0],todoTaskList:a.$(".todo-task-list"),addCatePanel:a.$(".add-cate-panel")[0],addCateSelect:a.$("#add-cate-main"),todoDetail:function(){var b=a.$("dd"),c=[];return a.each(b,function(a){c.push(a)}),c}(),removeIcon:function(){var b=a.$(".fa-trash-o"),c=[];return a.each(b,function(a){c.push(a)}),c}(),todoTaskItem:function(){for(var b=a.$(".todo-task-list"),c=b.length,d=[],e=0;c>e;e++){var f=b[e].getElementsByTagName("li");a.each(f,function(a){d.push(a)})}return d}(),todoDefault:function(){var b=a.$("#todo-default-title"),c=a.$("#todo-default-time"),d=a.$("#todo-default-content");return[b,c,d]}(),todoEdit:function(){var b=a.$("#todo-task-title"),c=a.$("#todo-task-time"),d=a.$("#todo-task-content");return b.style.display="none",c.style.display="none",d.style.display="none",[b,c,d]}()},d=function(b){a.stopBubble(b),b=b||window.event;var d=b.target||b.srcElement,e="";if(d.parentNode){switch(d.parentNode.className){case"todo-inventory-detail":e="todo-detail-selected";break;case"todo-inventory-category":e="todo-inventory-selected";break;case"todo-task-list":e="todo-task-selected";for(var f=0,g=c.todoTaskItem.length;g>f;f++)a.removeClass(c.todoTaskItem[f],e)}a.delegateInitClass(d,e)}},e=function(){var b=a.$(".todo-task-list")[0].getElementsByTagName("li")[0];b&&a.addClass(b,"todo-task-selected");var d=a.$("dd")[0];d&&a.addClass(d,"todo-detail-selected"),a.delegateInitClass(c.todoInventory[0],"todo-inventory-selected")},f=function(){c.todoTotal.innerHTML="("+s("data.tasks","all")+")"},g=function(){c.todoCateList.innerHTML=""},h=function(b){if(b.category){var d=a.$("[data-cate-id="+b.category+"]");if(!d){d=document.createElement("li"),d.setAttribute("data-cate-id",b.category);var e=document.createElement("span");if("默认分类"===b.category)e.innerHTML='<i class="fa fa-folder-open fa-fw"></i>'+b.category+"("+s("data.cates",b.category)+")";else{e.innerHTML='<i class="fa fa-folder-open fa-fw"></i>'+b.category+"("+s("data.cates",b.category)+")";var f=document.createElement("span");a.addClass(f,"remove-cate");var g=document.createElement("i");a.addClass(g,"fa fa-trash-o"),f.appendChild(g),e.appendChild(f),c.removeIcon.push(g)}d.appendChild(e),c.todoCateList.appendChild(d)}}},i=function(){a.each(c.todoTaskList,function(a){a.innerHTML=""})},j=function(b){var d=a.$("[data-cate-id="+b.category+"]"),e=document;if(b.taskList){if(!d.getElementsByTagName("ul")[0]){var f=e.createElement("ul");a.addClass(f,"todo-task-list"),d.appendChild(f)}if(d.getElementsByTagName("ul")[0]&&(f=d.getElementsByTagName("ul")[0],f.hasAttribute("class","todo-task-list"))){var g=a.$("[data-list-id="+b.taskList+"]");if(!g||"LI"!==g.nodeName.toUpperCase()){var h=e.createElement("li");if(h.setAttribute("data-list-id",b.taskList),"使用说明"===b.taskList)h.innerHTML='<i class="fa fa-file-o fa-fw"></i>'+b.taskList+"("+s("data.lists",b.taskList)+")";else{h.innerHTML='<i class="fa fa-file-o fa-fw"></i>'+b.taskList+"("+s("data.lists",b.taskList)+")";var i=document.createElement("span");a.addClass(i,"remove-list");var j=document.createElement("i");a.addClass(j,"fa fa-trash-o"),i.appendChild(j),h.appendChild(i),c.removeIcon.push(j)}f.appendChild(h),c.todoTaskItem.push(h)}}}},k=function(){c.taskInventory.innerHTML=""},l=function(b){if(b.cateList&&b.time){var d=new Date(b.time)-0,e=a.$("[data-list-time="+d+"]");if(e&&m(b),!e){var f=document.createElement("dt");f.setAttribute("data-list-time",d),f.innerHTML="<time>"+a.formatTime(b)+"</time>",c.taskInventory.appendChild(f),m(b)}}},m=function(a){if(a.title){var b=document.createElement("dd");a.isDone?(b.setAttribute("data-task-done","1"),b.innerHTML=a.title+'<i class="fa fa-smile-o"></i>'):(b.setAttribute("data-task-done","0"),b.innerHTML=a.title),b.setAttribute("data-list-id",a.cateList.taskList),b.setAttribute("data-task-id",a.id),c.taskInventory.appendChild(b),c.todoDetail.push(b)}},n=function(b){b&&(c.todoDefault[1].innerHTML=a.formatTime(b),c.todoDefault[0].setAttribute("data-task-id",b.id),c.todoDefault[0].innerHTML=b.title,c.todoDefault[2].innerHTML=b.content)},o=function(){c.addCateSelect.innerHTML="";var a=document.createElement("option");a.setAttribute("value","null"),a.innerHTML="新增主分类",c.addCateSelect.appendChild(a)},p=function(a){if(c.addCatePanel){var b=document.documentElement.clientWidth||document.body.clientWidth,d=document.documentElement.clientHeight||document.body.clientHeight,e=c.addCatePanel.offsetWidth,f=c.addCatePanel.offsetHeight;c.addCatePanel.style.position="absolute",b>768?c.addCatePanel.style.left=Math.round((b-e)/3.2)+"px":b>640&&768>=b?c.addCatePanel.style.left=Math.round(b/4.5)+"px":b>400&&640>=b?c.addCatePanel.style.left=Math.round(b/7.5)+"px":b>350&&400>=b?c.addCatePanel.style.left="20px":c.addCatePanel.style.left="0px",c.addCatePanel.style.top=Math.round((d-f)/3.2)+"px",c.addCatePanel.style.display=a}},q=function(a){var b=document.createElement("option");b.setAttribute("value",a),b.innerHTML=a,c.addCateSelect.appendChild(b)},r=function(b){switch(b){case"edit":c.todoEditIcon.style.display="none",c.todoCheckIcon.style.display="none",c.todoUndoEle.style.display="block",c.todoCheckEle.style.display="block",a.delegateEleEvent(c.todoDefault,function(a){a.style.display="none"}),a.delegateEleEvent(c.todoEdit,function(a){a.style.display="inline-block";for(var b=0,d=c.todoEdit.length;d>b;b++)c.todoEdit[b].value=c.todoDefault[b].innerHTML});break;case"check":c.todoEditIcon.style.display="block",c.todoCheckIcon.style.display="block",c.todoUndoEle.style.display="none",c.todoCheckEle.style.display="none",a.delegateEleEvent(c.todoDefault,function(a){a.style.display="inline",c.todoDefault[c.todoDefault.length-1].style.display="block"}),a.delegateEleEvent(c.todoEdit,function(a){a.style.display="none"});break;case"new":c.todoEditIcon.style.display="none",c.todoCheckIcon.style.display="none",c.todoUndoEle.style.display="block",c.todoCheckEle.style.display="block",a.delegateEleEvent(c.todoDefault,function(a){a.style.display="none"}),a.delegateEleEvent(c.todoEdit,function(a){a.style.display="inline-block",a.value=""})}},s=function(c,d){var e=0;switch(c){case"data.tasks":return a.each(b.tasks,function(a){a.isDone||e++}),e;case"data.lists":return a.each(b.tasks,function(a){a.isDone||a.cateList.taskList!==d||e++}),e;case"data.cates":return a.each(b.tasks,function(a){a.isDone||a.cateList.category!==d||e++}),e}},t=function(b){a.stopBubble(b),b=b||window.event;var c=b.target||b.srcElement;if("SPAN"===c.parentNode.nodeName){var d=c.parentNode.getAttribute("class");switch(d){case"remove-list":v(c.parentNode);break;case"remove-cate":u(c.parentNode)}}},u=function(c){if("LI"===c.parentNode.parentNode.nodeName){var d=c.parentNode.parentNode.getAttribute("data-cate-id");if(confirm("是否删除主分类【"+d+"】和所有子列表任务？删除后不可恢复╮(╯▽╰)╭")){var e=[];a.each(b.cates,function(a){a.category===d&&e.push(a)}),a.each(e,function(a){b.cates.remove(a)}),e.length=0,a.each(b.lists,function(a,b){a.category===d&&e.push(a)}),a.each(e,function(a){b.lists.remove(a)}),e.length=0,a.each(b.tasks,function(a,b){a.cateList.category===d&&e.push(a)}),a.each(e,function(a){b.tasks.remove(a)}),b.updateData(b.cates,b.lists,b.tasks),w(b.cates,b.lists)}}},v=function(c){if("LI"===c.parentNode.nodeName&&a.hasClass(c.parentNode,"todo-task-selected")){var d=c.parentNode.getAttribute("data-list-id");if(confirm("是否删除列表【"+d+"】和所有子任务？删除后不可恢复╮(╯▽╰)╭")){var e=[];a.each(b.lists,function(a,b){a.taskList===d&&e.push(a)}),a.each(e,function(a){b.lists.remove(a)}),e.length=0,a.each(b.tasks,function(a,b){a.cateList.taskList===d&&e.push(a)}),a.each(e,function(a){b.tasks.remove(a)}),b.updateData(b.cates,b.lists,b.tasks),w(b.cates,b.lists)}}else alert("选中列表后才能删除~")},w=function(e,k){g(),i(),o(),a.each(e,function(a){h(a),q(a.category)}),a.each(k,function(a){j(a)}),z(b.tasks,"all","all"),a.delegateClickEvent(c.removeIcon,t),a.delegateClickEvent(c.todoTaskItem,d),a.delegateClickEvent(c.todoTaskItem,y),f(),n(b.tasks[0])},x=function(c,d){if(a.getByteVal(d,20)){var e=a.checkXSS(a.getByteVal(d,20));"null"===c?confirm("确认创建新分类【"+e+"】吗？")&&b.cates.push(new b.Category({category:e})):confirm("确认在【"+c+"】分类下创建新列表【"+e+"】吗？")&&b.lists.push(new b.TaskList({category:c,taskList:e})),b.updateData(b.cates,b.lists,b.tasks),w(b.cates,b.lists)}},y=function(c){a.stopBubble(c),c=c||window.event;var d=c.target||c.srcElement;if("LI"===d.nodeName.toUpperCase()){var e=d.getAttribute("data-list-id");z(b.tasks,e,"all"),a.silder.init()&&a.silder.goIndex("1")}},z=function(b,d,e){switch(k(),b.sort(a.compare("time")),typeof e){case"string":"all"===d?a.each(b,function(a){l(a)}):a.each(b,function(a){a.cateList.taskList===d&&l(a)});break;case"boolean":e?"all"===d?a.each(b,function(a){a.isDone&&l(a)}):a.each(b,function(a){a.isDone&&a.cateList.taskList===d&&l(a)}):"all"===d?a.each(b,function(a){a.isDone||l(a)}):a.each(b,function(a){a.isDone||a.cateList.taskList!==d||l(a)})}a.delegateClickEvent(c.todoDetail,A)},A=function(c){a.stopBubble(c),c=c||window.event;var d=c.target||c.srcElement,e=d.getAttribute("data-task-id");a.each(b.tasks,function(b){b.id==e&&(n(b),a.silder.init()&&a.silder.goIndex("2"))})},B=function(){if(confirm("取消任务编辑吗？")){var d=c.todoDefault[0].getAttribute("data-task-id");r("check"),a.each(b.tasks,function(a){a.id==d&&n(a)})}},C=function(b){b=b||window.event;var c=b.target||b.srcElement,d="";switch("LI"===c.nodeName.toUpperCase()&&(d=c.id),"LI"===c.parentNode.nodeName.toUpperCase()&&(d=c.parentNode.id),d){case"todo-nav-cates":a.silder.init()&&a.silder.goIndex("0");break;case"todo-nav-inves":a.silder.init()&&a.silder.goIndex("1");break;case"todo-nav-tasks":a.silder.init()&&a.silder.goIndex("2")}},D=function(c){var d="";return 0==c?(alert("我是【使用说明】(～￣▽￣)～，不要调戏我~"),!1):(a.each(b.tasks,function(a){a.id==c&&(d=a)}),d)};return{todoCateList:c.todoCateList,removeIcon:c.removeIcon,todoTaskItem:c.todoTaskItem,todoInventory:c.todoInventory,taskInventory:c.taskInventory,todoEditIcon:c.todoEditIcon,todoCheckIcon:c.todoCheckIcon,todoUndoEle:c.todoUndoEle,todoCheckEle:c.todoCheckEle,todoDefault:c.todoDefault,todoDetail:c.todoDetail,todoEdit:c.todoEdit,addCateSelect:c.addCateSelect,classToggle:d,addCate:h,addList:j,addInventory:l,addContent:n,addCatePanel:p,addCateOption:q,renderEditChange:r,renderCount:f,renderFirstItem:e,todoCount:s,initCate:g,initList:i,initInventory:k,initSelect:o,removeCate:u,removeList:v,removeClick:t,isTaskDefault:D,reback:B,refreshInventory:z,refreshCate:w,taskItemClick:y,showTaskDetail:A,addCateList:x,silderGo:C}});